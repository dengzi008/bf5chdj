<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶ç«æ‰“åŠ«ï¼šç«ä¸­å–æ — - ä¸‰åå…­è®¡ç¬¬äº”è®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
            background: linear-gradient(135deg, #1a0000 0%, #4a0000 50%, #1a0000 100%);
            color: #fff;
            overflow: hidden;
            position: fixed;
            width: 100vw;
            height: 100vh;
        }

        #gameContainer {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #uiOverlay {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            height: 100%;
            pointer-events: none;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            flex-wrap: wrap;
            gap: 10px;
            pointer-events: auto;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .stat-item {
                font-size: 12px;
            }
            .top-bar {
                padding: 8px 10px;
            }
        }

        .chaos-bar-container {
            flex: 1;
            min-width: 150px;
            max-width: 300px;
        }

        .chaos-bar {
            width: 100%;
            height: 20px;
            background: rgba(100, 0, 0, 0.5);
            border: 2px solid #ff6600;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .chaos-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff3300 0%, #ff6600 50%, #ff9900 100%);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.8);
        }

        .middle-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
            pointer-events: auto;
        }

        .treasure-box {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            border: 3px solid #FFD700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            position: relative;
            pointer-events: auto;
        }

        .treasure-box:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        .treasure-box.active {
            animation: glow 1s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 1); }
        }

        .treasure-box.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .items-bar {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            pointer-events: auto;
        }

        .item-slot {
            width: 60px;
            height: 60px;
            background: rgba(50, 50, 50, 0.8);
            border: 2px solid #666;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .item-slot:hover {
            border-color: #ffaa00;
            transform: scale(1.1);
        }

        .item-slot.available {
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .item-slot.cooldown {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .item-slot.cooldown::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 6px;
        }

        .cooldown-text {
            position: absolute;
            font-size: 12px;
            color: #fff;
            z-index: 1;
        }

        .bottom-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            flex-wrap: wrap;
            pointer-events: auto;
        }

        .game-btn {
            padding: 12px 24px;
            font-size: 16px;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            border: 2px solid #FFD700;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            min-width: 120px;
        }

        .game-btn:hover {
            background: linear-gradient(135deg, #A0522D 0%, #CD853F 100%);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }

        .game-btn:active {
            transform: scale(0.95);
        }

        .game-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .game-btn {
                padding: 15px 20px;
                font-size: 18px;
                min-width: 140px;
            }
            .treasure-box {
                width: 60px;
                height: 60px;
                font-size: 30px;
            }
            .middle-area {
                gap: 10px;
                padding: 10px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #2a1a0a 0%, #4a2a1a 100%);
            border: 3px solid #FFD700;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        }

        .modal-content h2 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal-content p {
            margin: 15px 0;
            line-height: 1.6;
            font-size: 16px;
        }

        .modal-btn {
            padding: 12px 30px;
            font-size: 18px;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            border: 2px solid #FFD700;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }

        .modal-btn:hover {
            background: linear-gradient(135deg, #A0522D 0%, #CD853F 100%);
            transform: scale(1.05);
        }

        .event-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 100, 0, 0.95);
            border: 3px solid #ff6600;
            border-radius: 10px;
            padding: 20px;
            z-index: 999;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            animation: popup 0.5s;
            pointer-events: none;
        }

        @keyframes popup {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }

        .tutorial-content {
            background: linear-gradient(135deg, #1a0a00 0%, #3a1a0a 100%);
            border: 3px solid #ff6600;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            text-align: left;
        }

        .tutorial-content h3 {
            color: #ff6600;
            margin-bottom: 15px;
            text-align: center;
        }

        .tutorial-content ul {
            list-style: none;
            padding-left: 0;
        }

        .tutorial-content li {
            margin: 10px 0;
            padding-left: 25px;
            position: relative;
        }

        .tutorial-content li::before {
            content: 'ğŸ”¥';
            position: absolute;
            left: 0;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="uiOverlay">
            <div class="top-bar">
                <div class="stat-item">
                    <span>ä¹±åº¦:</span>
                    <div class="chaos-bar-container">
                        <div class="chaos-bar">
                            <div class="chaos-fill" id="chaosFill" style="width: 0%;"></div>
                        </div>
                    </div>
                    <span id="chaosPercent">0%</span>
                </div>
                <div class="stat-item">
                    <span>ğŸ’°ç²®è‰:</span>
                    <span id="foodCount">0</span>/1000
                </div>
                <div class="stat-item">
                    <span>ğŸŒŠæ³¢æ¬¡:</span>
                    <span id="waveCount">1</span>/âˆ
                </div>
                <div class="stat-item">
                    <span>â­é«˜åˆ†:</span>
                    <span id="highScore">0</span>
                </div>
            </div>

            <div class="middle-area">
                <div class="treasure-box" id="foodBox" title="æŠ¢ç²®ç®± - é£é™©ä½">ğŸŒ¾</div>
                <div class="treasure-box" id="goldBox" title="æŠ¢é‡‘åº“ - é«˜å›æŠ¥">ğŸ’°</div>
                <div class="treasure-box" id="allBox" title="å…¨æŠ¢ - è´ªå¿ƒå¤§å¥–">ğŸ’</div>
            </div>

            <div class="items-bar" style="justify-content: center; margin: 10px 0;">
                <div class="item-slot" id="itemInvisible" title="éšèº« - é™ä½é£é™©30%">ğŸ‘»</div>
                <div class="item-slot" id="itemHorse" title="å¿«é©¬ - å•æ¬¡æŠ¢50%">ğŸ</div>
                <div class="item-slot" id="itemBribe" title="è´¿èµ‚ - é™ä½ä¹±åº¦20%">ğŸ’°</div>
            </div>

            <div class="bottom-bar">
                <button class="game-btn" id="btnFood">æŠ¢ç²®ç®±(-é£é™©ä½)</button>
                <button class="game-btn" id="btnGold">æŠ¢é‡‘åº“(é«˜å›æŠ¥)</button>
                <button class="game-btn" id="btnAll">å…¨æŠ¢(è´ªå¿ƒå¤§å¥–)</button>
            </div>
        </div>

        <div id="tutorialModal" class="modal">
            <div class="tutorial-content">
                <h3>ğŸ”¥ è¶ç«æ‰“åŠ«ï¼šç«ä¸­å–æ — ğŸ”¥</h3>
                <p style="text-align: center; margin-bottom: 15px;">ä¸‰åå…­è®¡ç¬¬äº”è®¡</p>
                <ul>
                    <li>ç­‰å¾…ä¹±åº¦ä¸Šå‡ï¼Œè¶æ•ŒåŸæ··ä¹±æ—¶è¡ŒåŠ¨</li>
                    <li>æŠ¢ç²®ç®±é£é™©ä½ä½†æ”¶ç›Šå°</li>
                    <li>æŠ¢é‡‘åº“æ”¶ç›Šé«˜ä½†é£é™©å¤§</li>
                    <li>å…¨æŠ¢æ”¶ç›Šæœ€å¤§ä½†é£é™©æé«˜</li>
                    <li>ä¹±åº¦>70%æ—¶é£é™©ç¿»å€</li>
                    <li>ä½¿ç”¨é“å…·å¯ä»¥é™ä½é£é™©æˆ–å¢åŠ æ”¶ç›Š</li>
                    <li>ç›®æ ‡ï¼šæ”¶é›†1000ç²®è‰è·èƒœ</li>
                </ul>
                <button class="modal-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
            </div>
        </div>

        <div id="endModal" class="modal">
            <div class="modal-content">
                <h2 id="endTitle">æ¸¸æˆç»“æŸ</h2>
                <p id="endMessage"></p>
                <p id="endScore"></p>
                <button class="modal-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        const gameState = {
            chaos: 0,           // ä¹±åº¦ 0-100
            food: 0,            // ç²®è‰
            wave: 1,            // å½“å‰æ³¢æ¬¡
            highScore: 0,       // æœ€é«˜åˆ†
            caught: 0,          // è¢«æŠ“æ¬¡æ•°
            gameRunning: false,
            nextDisasterTime: 0,
            disasterInterval: 20000, // 20ç§’ä¸€æ³¢
            items: {
                invisible: { available: true, cooldown: 0, cdTime: 15000 },
                horse: { available: true, cooldown: 0, cdTime: 0 },
                bribe: { available: true, cooldown: 0, cdTime: 0 }
            },
            horseUsed: false,   // å¿«é©¬æ˜¯å¦å·²ä½¿ç”¨
            seed: Date.now()    // éšæœºç§å­
        };

        // ==================== Canvas è®¾ç½® ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let canvasWidth = window.innerWidth;
        let canvasHeight = window.innerHeight;

        function resizeCanvas() {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ==================== ç²’å­ç³»ç»Ÿ ====================
        const particles = [];
        const fireParticles = [];
        const thiefParticles = [];

        class Particle {
            constructor(x, y, vx, vy, color, life = 60) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.life = life;
                this.maxLife = life;
                this.size = Math.random() * 3 + 2;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.1; // é‡åŠ›
                this.life--;
            }

            draw() {
                const alpha = this.life / this.maxLife;
                ctx.globalAlpha = alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }

            isDead() {
                return this.life <= 0 || this.x < 0 || this.x > canvasWidth || this.y > canvasHeight;
            }
        }

        // ==================== éšæœºæ•°ç”Ÿæˆå™¨ï¼ˆå¸¦ç§å­ï¼‰====================
        let rngSeed = gameState.seed;
        function random() {
            rngSeed = (rngSeed * 9301 + 49297) % 233280;
            return rngSeed / 233280;
        }

        function randomInt(min, max) {
            return Math.floor(random() * (max - min + 1)) + min;
        }

        // ==================== éŸ³æ•ˆç³»ç»Ÿ ====================
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                switch(type) {
                    case 'fire':
                        oscillator.frequency.value = 100 + random() * 50;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.value = 0.1;
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.1);
                        break;
                    case 'success':
                        oscillator.frequency.value = 400;
                        oscillator.type = 'sine';
                        gainNode.gain.value = 0.2;
                        oscillator.start();
                        oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.2);
                        oscillator.stop(audioContext.currentTime + 0.3);
                        break;
                    case 'fail':
                        oscillator.frequency.value = 200;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.value = 0.2;
                        oscillator.start();
                        oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                        oscillator.stop(audioContext.currentTime + 0.4);
                        break;
                    case 'victory':
                        for(let i = 0; i < 5; i++) {
                            setTimeout(() => {
                                const osc = audioContext.createOscillator();
                                const gain = audioContext.createGain();
                                osc.connect(gain);
                                gain.connect(audioContext.destination);
                                osc.frequency.value = 300 + i * 100;
                                osc.type = 'sine';
                                gain.gain.value = 0.15;
                                osc.start();
                                osc.stop(audioContext.currentTime + 0.2);
                            }, i * 100);
                        }
                        break;
                }
            } catch(e) {
                // éŸ³æ•ˆå¤±è´¥ä¸å½±å“æ¸¸æˆ
            }
        }

        // ==================== ç»˜åˆ¶æ¸¸æˆç”»é¢ ====================
        function drawGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#1a0000';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // ç»˜åˆ¶ç«å…‰æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, canvasWidth, canvasHeight);
            gradient.addColorStop(0, '#4a0000');
            gradient.addColorStop(0.3, '#8a2000');
            gradient.addColorStop(0.6, '#ff3300');
            gradient.addColorStop(1, '#4a0000');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // ç»˜åˆ¶æ•ŒåŸï¼ˆå³ä¾§ï¼‰
            const cityX = canvasWidth * 0.7;
            const cityY = canvasHeight * 0.3;
            ctx.fillStyle = '#333';
            ctx.fillRect(cityX, cityY, 150, 200);
            ctx.fillStyle = '#ff6600';
            ctx.fillRect(cityX + 20, cityY + 50, 110, 150);
            
            // ç»˜åˆ¶ç«ç„°
            for(let i = 0; i < 20; i++) {
                const fx = cityX + 20 + random() * 110;
                const fy = cityY + 50 + random() * 150;
                ctx.fillStyle = `rgba(255, ${100 + random() * 155}, 0, ${0.6 + random() * 0.4})`;
                ctx.beginPath();
                ctx.arc(fx, fy, 10 + random() * 15, 0, Math.PI * 2);
                ctx.fill();
            }

            // ç»˜åˆ¶å±±å¯¨ï¼ˆå·¦ä¾§ï¼‰
            const baseX = canvasWidth * 0.1;
            const baseY = canvasHeight * 0.5;
            ctx.fillStyle = '#2a4a2a';
            ctx.fillRect(baseX, baseY, 100, 120);
            ctx.fillStyle = '#4a6a4a';
            ctx.fillRect(baseX + 10, baseY + 10, 80, 100);

            // ç»˜åˆ¶ç²®è‰æ¡ï¼ˆå±±å¯¨å†…ï¼‰
            const foodBarWidth = 60;
            const foodBarHeight = 10;
            const foodBarX = baseX + 20;
            const foodBarY = baseY + 80;
            ctx.fillStyle = '#333';
            ctx.fillRect(foodBarX, foodBarY, foodBarWidth, foodBarHeight);
            ctx.fillStyle = '#00ff00';
            const foodPercent = Math.min(gameState.food / 1000, 1);
            ctx.fillRect(foodBarX, foodBarY, foodBarWidth * foodPercent, foodBarHeight);

            // ç»˜åˆ¶è¡—å··æ··ä¹±ï¼ˆè´¼å…µï¼‰
            for(let i = 0; i < 5; i++) {
                const thiefX = canvasWidth * 0.3 + random() * canvasWidth * 0.4;
                const thiefY = canvasHeight * 0.4 + random() * canvasHeight * 0.3;
                ctx.font = '30px Arial';
                ctx.fillText('ğŸº', thiefX, thiefY);
            }

            // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
            for(let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if(particles[i].isDead()) {
                    particles.splice(i, 1);
                }
            }

            // ç»˜åˆ¶ç«ç„°ç²’å­
            for(let i = fireParticles.length - 1; i >= 0; i--) {
                fireParticles[i].update();
                fireParticles[i].draw();
                if(fireParticles[i].isDead()) {
                    fireParticles[i].x = cityX + 20 + random() * 110;
                    fireParticles[i].y = cityY + 200;
                    fireParticles[i].vx = (random() - 0.5) * 2;
                    fireParticles[i].vy = -random() * 3 - 1;
                    fireParticles[i].life = fireParticles[i].maxLife;
                }
            }

            // æŒç»­ç”Ÿæˆç«ç„°ç²’å­
            if(fireParticles.length < 30) {
                fireParticles.push(new Particle(
                    cityX + 20 + random() * 110,
                    cityY + 200,
                    (random() - 0.5) * 2,
                    -random() * 3 - 1,
                    `rgb(255, ${100 + random() * 155}, 0)`,
                    60
                ));
            }
        }

        // ==================== æ˜¾ç¤ºäº‹ä»¶å¼¹çª— ====================
        function showEventPopup(text) {
            const popup = document.createElement('div');
            popup.className = 'event-popup';
            popup.textContent = text;
            document.body.appendChild(popup);
            setTimeout(() => {
                popup.style.animation = 'popup 0.5s reverse';
                setTimeout(() => popup.remove(), 500);
            }, 2000);
        }

        // ==================== ç”Ÿæˆèƒœåˆ©ç²’å­ ====================
        function createVictoryParticles() {
            for(let i = 0; i < 100; i++) {
                particles.push(new Particle(
                    canvasWidth / 2,
                    canvasHeight / 2,
                    (random() - 0.5) * 10,
                    (random() - 0.5) * 10 - 5,
                    `rgb(255, ${200 + random() * 55}, 0)`,
                    120
                ));
            }
        }

        // ==================== ç¾éš¾äº‹ä»¶ ====================
        function triggerDisaster() {
            const disasterType = randomInt(1, 3);
            let chaosIncrease = 0;
            let message = '';

            switch(disasterType) {
                case 1: // ç«ç¾
                    chaosIncrease = 20;
                    message = 'ğŸ”¥ æ•ŒåŸå¤§ç«ï¼ä¹±åº¦+20%';
                    playSound('fire');
                    break;
                case 2: // å›ä¹±
                    chaosIncrease = 30;
                    message = 'âš”ï¸ æ•ŒåŸå›ä¹±ï¼ä¹±åº¦+30%';
                    break;
                case 3: // æ´ªæ°´
                    chaosIncrease = 15;
                    message = 'ğŸŒŠ æ´ªæ°´æ¥è¢­ï¼ä¹±åº¦+15%ï¼Œå®ç®±äº®èµ·ï¼';
                    // æ¿€æ´»æ‰€æœ‰å®ç®±
                    document.getElementById('foodBox').classList.add('active');
                    document.getElementById('goldBox').classList.add('active');
                    document.getElementById('allBox').classList.add('active');
                    setTimeout(() => {
                        document.getElementById('foodBox').classList.remove('active');
                        document.getElementById('goldBox').classList.remove('active');
                        document.getElementById('allBox').classList.remove('active');
                    }, 5000);
                    break;
            }

            gameState.chaos = Math.min(100, gameState.chaos + chaosIncrease);
            showEventPopup(message);
            updateUI();
        }

        // ==================== éšæœºäº‹ä»¶ ====================
        function triggerRandomEvent() {
            if(random() < 0.2) { // 20%æ¦‚ç‡
                if(random() < 0.5) {
                    // æ•Œå°†è¿½å‡»
                    gameState.food = Math.max(0, gameState.food - 100);
                    showEventPopup('âš”ï¸ æ•Œå°†æ€’è¿½ï¼ç¿»è½¦-100ç²®');
                    playSound('fail');
                } else {
                    // æ°‘ä¼—æ„Ÿè°¢
                    gameState.food += 100;
                    showEventPopup('ğŸ™ æ°‘ä¼—æ„Ÿè°¢ï¼+100ç²®ï¼Œåå£°+1');
                    playSound('success');
                }
                updateUI();
            }
        }

        // ==================== æŠ¢åŠ«è¡ŒåŠ¨ ====================
        function attemptRobbery(type, baseRisk, reward) {
            if(!gameState.gameRunning) return;

            let risk = baseRisk;
            let finalReward = reward;

            // ä¹±åº¦>70%é£é™©ç¿»å€
            if(gameState.chaos > 70) {
                risk *= 2;
            }

            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨å¿«é©¬
            if(gameState.items.horse.available && gameState.horseUsed === false) {
                finalReward = Math.floor(reward * 1.5);
                gameState.horseUsed = true;
                gameState.items.horse.available = false;
                updateItemUI();
            }

            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨éšèº«
            if(gameState.items.invisible.available && gameState.items.invisible.cooldown === 0) {
                risk = Math.max(0, risk - 30);
                gameState.items.invisible.cooldown = gameState.items.invisible.cdTime;
                gameState.items.invisible.available = false;
                updateItemUI();
                setTimeout(() => {
                    gameState.items.invisible.available = true;
                    updateItemUI();
                }, gameState.items.invisible.cdTime);
            }

            // åˆ¤æ–­æ˜¯å¦æˆåŠŸ
            const success = random() * 100 >= risk;

            if(success) {
                gameState.food += finalReward;
                showEventPopup(`âœ… æˆåŠŸï¼+${finalReward}ç²®`);
                playSound('success');
                
                // åˆ›å»ºæˆåŠŸç²’å­
                for(let i = 0; i < 20; i++) {
                    particles.push(new Particle(
                        canvasWidth / 2,
                        canvasHeight / 2,
                        (random() - 0.5) * 5,
                        (random() - 0.5) * 5 - 2,
                        `rgb(255, ${200 + random() * 55}, 0)`,
                        60
                    ));
                }
            } else {
                gameState.caught++;
                gameState.food = Math.max(0, gameState.food - 100);
                showEventPopup('âŒ è¢«æŠ“ï¼-100ç²®ï¼Œé‡ç½®ä¹±åº¦');
                gameState.chaos = 0;
                playSound('fail');
                
                // åˆ›å»ºå¤±è´¥ç²’å­ï¼ˆç°è‰²ï¼‰
                for(let i = 0; i < 30; i++) {
                    particles.push(new Particle(
                        canvasWidth / 2,
                        canvasHeight / 2,
                        (random() - 0.5) * 8,
                        (random() - 0.5) * 8 - 3,
                        `rgb(100, 100, 100)`,
                        80
                    ));
                }
            }

            // è§¦å‘éšæœºäº‹ä»¶
            triggerRandomEvent();

            updateUI();
            checkGameEnd();
        }

        // ==================== ä½¿ç”¨é“å…· ====================
        function useItem(itemType) {
            if(!gameState.gameRunning) return;

            switch(itemType) {
                case 'invisible':
                    if(gameState.items.invisible.cooldown > 0) return;
                    // éšèº«åœ¨ä½¿ç”¨æŠ¢åŠ«æ—¶è‡ªåŠ¨è§¦å‘
                    showEventPopup('ğŸ‘» éšèº«å·²æ¿€æ´»ï¼Œä¸‹æ¬¡æŠ¢åŠ«é™ä½é£é™©');
                    break;
                case 'horse':
                    if(!gameState.items.horse.available || gameState.horseUsed) return;
                    gameState.horseUsed = true;
                    gameState.items.horse.available = false;
                    showEventPopup('ğŸ å¿«é©¬å·²æ¿€æ´»ï¼Œä¸‹æ¬¡æŠ¢åŠ«+50%æ”¶ç›Š');
                    updateItemUI();
                    break;
                case 'bribe':
                    gameState.chaos = Math.max(0, gameState.chaos - 20);
                    showEventPopup('ğŸ’° è´¿èµ‚æˆåŠŸï¼ä¹±åº¦-20%');
                    playSound('success');
                    updateUI();
                    break;
            }
        }

        // ==================== æ›´æ–°UI ====================
        function updateUI() {
            document.getElementById('chaosFill').style.width = gameState.chaos + '%';
            document.getElementById('chaosPercent').textContent = Math.round(gameState.chaos) + '%';
            document.getElementById('foodCount').textContent = gameState.food;
            document.getElementById('waveCount').textContent = gameState.wave;
            document.getElementById('highScore').textContent = gameState.highScore;

            // æ›´æ–°ä¹±åº¦æ¡é¢œè‰²
            const chaosFill = document.getElementById('chaosFill');
            if(gameState.chaos > 70) {
                chaosFill.style.background = 'linear-gradient(90deg, #ff0000 0%, #ff3300 50%, #ff6600 100%)';
            } else {
                chaosFill.style.background = 'linear-gradient(90deg, #ff3300 0%, #ff6600 50%, #ff9900 100%)';
            }
        }

        function updateItemUI() {
            // éšèº«
            const invisibleSlot = document.getElementById('itemInvisible');
            if(gameState.items.invisible.cooldown > 0) {
                invisibleSlot.classList.add('cooldown');
                invisibleSlot.querySelector('.cooldown-text')?.remove();
                const cdText = document.createElement('div');
                cdText.className = 'cooldown-text';
                cdText.textContent = Math.ceil(gameState.items.invisible.cooldown / 1000);
                invisibleSlot.appendChild(cdText);
            } else {
                invisibleSlot.classList.remove('cooldown');
                invisibleSlot.querySelector('.cooldown-text')?.remove();
                if(gameState.items.invisible.available) {
                    invisibleSlot.classList.add('available');
                } else {
                    invisibleSlot.classList.remove('available');
                }
            }

            // å¿«é©¬
            const horseSlot = document.getElementById('itemHorse');
            if(gameState.items.horse.available && !gameState.horseUsed) {
                horseSlot.classList.add('available');
            } else {
                horseSlot.classList.remove('available');
            }

            // è´¿èµ‚
            const bribeSlot = document.getElementById('itemBribe');
            bribeSlot.classList.add('available');
        }

        // ==================== æ£€æŸ¥æ¸¸æˆç»“æŸ ====================
        function checkGameEnd() {
            if(gameState.food >= 1000) {
                // èƒœåˆ©
                gameState.gameRunning = false;
                const score = Math.floor(gameState.food * Math.pow(1.2, 3 - Object.values(gameState.items).filter(i => i.available).length));
                if(score > gameState.highScore) {
                    gameState.highScore = score;
                    localStorage.setItem('highScore', gameState.highScore);
                }

                playSound('victory');
                createVictoryParticles();

                let title = 'ğŸ‰ å¤§èƒœï¼';
                let message = '';
                if(gameState.food >= 1500) {
                    message = 'ä»ä¹‰ä¹‹å¸ˆï¼ä½ ä¸ä»…è·å¾—äº†èƒœåˆ©ï¼Œè¿˜èµ¢å¾—äº†æ°‘å¿ƒï¼\n\n';
                    message += 'ã€Œè¶ç«æ‰“åŠ«ã€å‡ºè‡ªã€Šä¸‰åå…­è®¡ã€‹ï¼ŒæŒ‡è¶äººå®¶å¤±ç«æ—¶å»æŠ¢åŠ«ã€‚\n';
                    message += 'æ¯”å–»ä¹˜äººä¹‹å±è°‹å–ç§åˆ©ã€‚åœ¨æˆ˜äº‰ä¸­ï¼Œè¦å–„äºæŠ“ä½æ•Œäººçš„å¼±ç‚¹ï¼Œ\n';
                    message += 'åœ¨æ•Œäººå¤„äºæ··ä¹±ã€å±æœºæ—¶å‘åŠ¨æ”»å‡»ï¼Œå¾€å¾€èƒ½å–å¾—äº‹åŠåŠŸå€çš„æ•ˆæœã€‚\n\n';
                } else {
                    message = 'æˆåŠŸè¶ç«æ‰“åŠ«ï¼ä½ æŠ“ä½äº†æ•Œäººçš„æ··ä¹±æ—¶æœºï¼Œè·å¾—äº†èƒœåˆ©ï¼\n\n';
                    message += 'ã€Œè¶ç«æ‰“åŠ«ã€å‡ºè‡ªã€Šä¸‰åå…­è®¡ã€‹ï¼ŒæŒ‡è¶äººå®¶å¤±ç«æ—¶å»æŠ¢åŠ«ã€‚\n';
                    message += 'æ¯”å–»ä¹˜äººä¹‹å±è°‹å–ç§åˆ©ã€‚åœ¨æˆ˜äº‰ä¸­ï¼Œè¦å–„äºæŠ“ä½æ•Œäººçš„å¼±ç‚¹ï¼Œ\n';
                    message += 'åœ¨æ•Œäººå¤„äºæ··ä¹±ã€å±æœºæ—¶å‘åŠ¨æ”»å‡»ï¼Œå¾€å¾€èƒ½å–å¾—äº‹åŠåŠŸå€çš„æ•ˆæœã€‚\n\n';
                }
                message += `æœ€ç»ˆç²®è‰ï¼š${gameState.food}\n`;
                message += `æ¸¸æˆåˆ†æ•°ï¼š${score}\n`;
                message += `æœ€é«˜åˆ†ï¼š${gameState.highScore}`;

                document.getElementById('endTitle').textContent = title;
                document.getElementById('endMessage').textContent = message;
                document.getElementById('endScore').textContent = '';
                document.getElementById('endModal').classList.add('active');
            } else if(gameState.food < 0 || gameState.caught >= 3) {
                // å¤±è´¥
                gameState.gameRunning = false;
                playSound('fail');

                const title = 'ğŸ”¥ ç«çƒ¤å±±è´¼ï¼';
                let message = 'ä½ è¢«æ•ŒäººæŠ“ä½äº†ï¼è¶ç«æ‰“åŠ«å¤±è´¥ï¼\n\n';
                message += 'ã€Œè¶ç«æ‰“åŠ«ã€è™½æ˜¯å¥½è®¡ï¼Œä½†ä¹Ÿè¦å®¡æ—¶åº¦åŠ¿ï¼Œ\n';
                message += 'ä¸èƒ½è´ªå¿ƒè¿‡åº¦ï¼Œå¦åˆ™åè€Œä¼šå¼•ç«çƒ§èº«ã€‚\n\n';
                message += `æœ€ç»ˆç²®è‰ï¼š${gameState.food}\n`;
                message += `è¢«æŠ“æ¬¡æ•°ï¼š${gameState.caught}\n`;
                message += `æœ€é«˜åˆ†ï¼š${gameState.highScore}`;

                document.getElementById('endTitle').textContent = title;
                document.getElementById('endMessage').textContent = message;
                document.getElementById('endScore').textContent = '';
                document.getElementById('endModal').classList.add('active');
            }
        }

        // ==================== æ¸¸æˆä¸»å¾ªç¯ ====================
        function gameLoop() {
            if(!gameState.gameRunning) return;

            const now = Date.now();

            // æ›´æ–°é“å…·å†·å´
            if(gameState.items.invisible.cooldown > 0) {
                gameState.items.invisible.cooldown = Math.max(0, gameState.items.invisible.cooldown - 16);
                updateItemUI();
            }

            // æ£€æŸ¥ç¾éš¾äº‹ä»¶
            if(now >= gameState.nextDisasterTime) {
                triggerDisaster();
                gameState.nextDisasterTime = now + gameState.disasterInterval;
                gameState.wave++;
            }

            // ç»˜åˆ¶æ¸¸æˆ
            drawGame();

            requestAnimationFrame(gameLoop);
        }

        // ==================== å¼€å§‹æ¸¸æˆ ====================
        function startGame() {
            document.getElementById('tutorialModal').classList.remove('active');
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.chaos = 0;
            gameState.food = 0;
            gameState.wave = 1;
            gameState.caught = 0;
            gameState.gameRunning = true;
            gameState.nextDisasterTime = Date.now() + gameState.disasterInterval;
            gameState.items.invisible.available = true;
            gameState.items.invisible.cooldown = 0;
            gameState.items.horse.available = true;
            gameState.items.bribe.available = true;
            gameState.horseUsed = false;
            gameState.seed = Date.now();
            rngSeed = gameState.seed;

            // åŠ è½½æœ€é«˜åˆ†
            const savedHighScore = localStorage.getItem('highScore');
            if(savedHighScore) {
                gameState.highScore = parseInt(savedHighScore);
            }

            particles.length = 0;
            fireParticles.length = 0;

            updateUI();
            updateItemUI();
            gameLoop();
        }

        // ==================== é‡æ–°å¼€å§‹ ====================
        function restartGame() {
            document.getElementById('endModal').classList.remove('active');
            document.getElementById('tutorialModal').classList.add('active');
        }

        // ==================== äº‹ä»¶ç»‘å®š ====================
        document.getElementById('btnFood').addEventListener('click', () => {
            attemptRobbery('food', 10, 200);
        });

        document.getElementById('btnGold').addEventListener('click', () => {
            attemptRobbery('gold', 20, 400);
        });

        document.getElementById('btnAll').addEventListener('click', () => {
            attemptRobbery('all', 40, 700);
        });

        document.getElementById('itemInvisible').addEventListener('click', () => {
            useItem('invisible');
        });

        document.getElementById('itemHorse').addEventListener('click', () => {
            useItem('horse');
        });

        document.getElementById('itemBribe').addEventListener('click', () => {
            useItem('bribe');
        });

        // è§¦æ‘¸äº‹ä»¶æ”¯æŒï¼ˆç§»åŠ¨ç«¯ï¼‰
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            // ç®€å•çš„æ‹–æ‹½æ£€æµ‹ï¼ˆå¯ä»¥æ‰©å±•ä¸ºé“å…·æ‹–æ‹½ï¼‰
            if(Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) {
                // ç‚¹å‡»äº‹ä»¶å·²ç”±æŒ‰é’®å¤„ç†
            }
        }, { passive: true });

        // ==================== åˆå§‹åŒ– ====================
        window.addEventListener('load', () => {
            // åŠ è½½æœ€é«˜åˆ†
            const savedHighScore = localStorage.getItem('highScore');
            if(savedHighScore) {
                gameState.highScore = parseInt(savedHighScore);
                updateUI();
            }

            // æ˜¾ç¤ºæ•™ç¨‹
            document.getElementById('tutorialModal').classList.add('active');

            // å¼€å§‹ç»˜åˆ¶ï¼ˆå³ä½¿æ¸¸æˆæœªå¼€å§‹ä¹Ÿç»˜åˆ¶èƒŒæ™¯ï¼‰
            function initDraw() {
                drawGame();
                if(!gameState.gameRunning) {
                    requestAnimationFrame(initDraw);
                }
            }
            initDraw();
        });

        // é˜²æ­¢é¡µé¢æ»šåŠ¨ï¼ˆç§»åŠ¨ç«¯ï¼‰
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
